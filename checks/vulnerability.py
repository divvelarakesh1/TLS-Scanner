import socket
import struct
import time
import subprocess
import shutil
from typing import Optional, List, Dict, Any, Tuple
from datetime import datetime
from core.base_check import BaseCheck
from core.models import Finding, Severity
from core.context import ConnectionContext
import ssl as ssl_module
import os

# to test for renegotiation check
# tls-attacker.de

class VulnerabilityCheck(BaseCheck):
    """
    Checks for major TLS vulnerabilities requiring special probes, including:
    - Insecure Renegotiation (Client-initiated renegotiation) 
    """
    
    OPENSSL_TIMEOUT = 10
    SOCKET_TIMEOUT = 5
    
    TLS_HEARTBEAT = 0x18
    TLS_ALERT = 0x15
    TLS_HANDSHAKE = 0x16
    
    HEARTBEAT_REQUEST = 0x01
    HEARTBEAT_RESPONSE = 0x02

    def run(self, context: ConnectionContext) -> List[Finding]:
        findings: List[Finding] = []

        # Insecure Renegotiation
        reneg_finding = self._check_insecure_renegotiation_python(context)
        if reneg_finding:
            findings.append(reneg_finding)
        
        if not reneg_finding and shutil.which("openssl"):
            reneg_openssl = self._check_insecure_renegotiation_openssl(context)
            if reneg_openssl:
                findings.append(reneg_openssl)

        return findings
    
    def _check_insecure_renegotiation_python(self, context: ConnectionContext) -> Optional[Finding]:
        """
        Check for insecure renegotiation using Python's SSL library.
        This is more reliable than raw sockets for renegotiation checks.
        """
        host = context.target.hostname
        port = context.target.port
        
        try:
            ctx = ssl_module.SSLContext(ssl_module.PROTOCOL_TLS_CLIENT)
            ctx.check_hostname = False
            ctx.verify_mode = ssl_module.CERT_NONE
            
            ctx.options &= ~ssl_module.OP_NO_SSLv3
            ctx.options &= ~ssl_module.OP_NO_TLSv1
            ctx.options &= ~ssl_module.OP_NO_TLSv1_1
            ctx.set_ciphers("ALL:@SECLEVEL=0")
            
            sock = socket.create_connection((host, port), timeout=self.SOCKET_TIMEOUT)
            ssl_sock = ctx.wrap_socket(sock, server_hostname=host)
            
            has_secure_reneg = False
            
            if hasattr(ssl_module, 'OP_NO_RENEGOTIATION'):
                try:
                    ssl_sock.getpeercert()
                    ssl_sock.do_handshake()
                    
                    openssl_version = ssl_module.OPENSSL_VERSION
                    
                    if "OpenSSL 0." in openssl_version or "OpenSSL 1.0.0" in openssl_version:
                        ssl_sock.close()
                        return self.create_finding(
                            severity=Severity.HIGH,
                            title="Insecure TLS Renegotiation Possible (Old OpenSSL)",
                            description=f"Server is using old OpenSSL ({openssl_version}) which may not support RFC 5746 Secure Renegotiation.",
                            remediation="Upgrade OpenSSL to version 1.0.1+ and enable RFC 5746 Secure Renegotiation.",
                            metadata={"openssl_version": openssl_version}
                        )
                    
                except Exception:
                    pass
            
            ssl_sock.close()
            
        except Exception:
            pass
        
        return None

    def _check_insecure_renegotiation_openssl(self, context: ConnectionContext) -> Optional[Finding]:
        """
        Check for insecure renegotiation using OpenSSL s_client.
        This is the most accurate method for detecting CVE-2009-3555.
        """
        host = context.target.hostname
        port = context.target.port
        
        cmd = [
            "openssl", "s_client",
            "-connect", f"{host}:{port}",
            "-servername", host,
            "-cipher", "ALL:@SECLEVEL=0",
            "-no_ticket",  
            "-status"      
        ]

        try:
            proc = subprocess.run(
                cmd, 
                input="GET / HTTP/1.0\r\n\r\n",
                capture_output=True, 
                timeout=self.OPENSSL_TIMEOUT, 
                text=True
            )
            output = (proc.stdout or "") + (proc.stderr or "")
            output_lower = output.lower()
            
            if "secure renegotiation is not supported" in output_lower:
                return self.create_finding(
                    severity=Severity.HIGH,
                    title="Insecure TLS Renegotiation (CVE-2009-3555)",
                    description="Server does NOT support RFC 5746 Secure Renegotiation. This allows Man-in-the-Middle attackers to inject plaintext into TLS sessions during renegotiation.",
                    remediation="Enable RFC 5746 Secure Renegotiation in server configuration:\n- Apache: SSLInsecureRenegotiation off\n- Nginx: Upgrade to version with secure renegotiation\n- Consider disabling client-initiated renegotiation entirely.",
                    metadata={"cve": "CVE-2009-3555", "rfc": "RFC 5746"}
                )
            
            if "insecure renegotiation" in output_lower and "supported" in output_lower:
                return self.create_finding(
                    severity=Severity.CRITICAL,
                    title="Insecure TLS Renegotiation Explicitly Enabled",
                    description="Server explicitly supports insecure renegotiation, which is a severe security vulnerability.",
                    remediation="Disable insecure renegotiation immediately in server configuration.",
                    metadata={"cve": "CVE-2009-3555"}
                )
            
            if "secure renegotiation is supported" in output_lower or \
               "secure renegotiation: yes" in output_lower:
                return None
            
            cmd_reneg = [
                "openssl", "s_client",
                "-connect", f"{host}:{port}",
                "-servername", host,
                "-cipher", "ALL:@SECLEVEL=0",
                "-reconnect" 
            ]
            
            proc_reneg = subprocess.run(
                cmd_reneg,
                input="R\n",
                capture_output=True,
                timeout=self.OPENSSL_TIMEOUT,
                text=True
            )
            
            reneg_output = (proc_reneg.stdout or "") + (proc_reneg.stderr or "")
            reneg_lower = reneg_output.lower()
            
            if "renegotiation" in reneg_lower and "failure" not in reneg_lower:
                if "secure renegotiation" not in reneg_lower:
                    return self.create_finding(
                        severity=Severity.HIGH,
                        title="Client-Initiated Renegotiation Allowed",
                        description="Server allows client-initiated renegotiation. If RFC 5746 is not properly implemented, this is vulnerable to CVE-2009-3555.",
                        remediation="Verify RFC 5746 is enabled, or disable client-initiated renegotiation.",
                        metadata={"cve": "CVE-2009-3555"}
                    )
            
        except subprocess.TimeoutExpired:
            return None
        except Exception:
            return None
        
        return None